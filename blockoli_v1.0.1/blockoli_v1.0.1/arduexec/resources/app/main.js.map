{"version":3,"file":"main.js","sources":["app/main.js"],"sourcesContent":["/**\n * @author    carlosperate\n * @copyright 2015 carlosperate https://github.com/carlosperate\n * @license   Licensed under the The MIT License (MIT), a copy can be found in\n *            the electron project directory LICENSE file.\n *\n * @fileoverview Electron entry point continues here. Creates windows and\n *               handles system events.\n */\nconst electron = require('electron');\nconst app = electron.app;\nconst BrowserWindow = electron.BrowserWindow;\n\nconst appMenu = require('./appmenu.js');\nconst server = require('./servermgr.js');\nconst projectLocator = require('./projectlocator.js');\nconst createWindow = require('./helpers/window');\n\nconst winston = require('winston');\nconst packageData = require('fs-jetpack').cwd(app.getAppPath()).read('package.json', 'json');\n\nconst tag = '[ArdublocklyElec] ';\n\n// Global reference of the window object must be maintain, or the window will\n// be closed automatically when the JavaScript object is garbage collected.\nvar mainWindow = null;\nvar splashWindow = null;\n\n// Set up the app data directory within the Ardublockly root directory\n(function setAppData() {\n    var appDataPath = projectLocator.getExecDirJetpack().cwd('appdata');\n    app.setPath('appData', appDataPath.path());\n    app.setPath('userData', appDataPath.path());\n    app.setPath('cache', appDataPath.path('GenCache'));\n    app.setPath('userCache', appDataPath.path('AppCache'));\n    app.setPath('temp', appDataPath.path('temp'));\n})();\n\n// Ensure this is a single instance application\nconst shouldQuit = app.makeSingleInstance(function(cmdLine, workingDirectory) {\n  // User tried to run a second instance, focus existing window.\n  if (mainWindow) {\n    if (mainWindow.isMinimized()) mainWindow.restore();\n    mainWindow.focus();\n  }\n});\n\n// Electron application entry point\napp.on('ready', function() {\n    if (shouldQuit) {\n      app.quit();\n      return;\n    }\n\n    setupLogging();\n    createSplashWindow();\n    server.startServer();\n\n    mainWindow = createWindow('main', {\n        width: 1200,\n        height: 765,\n        title: 'Ardublockly',\n        transparent: false,\n        backgroundColor: '#EEEEEE',\n        frame: true,\n        show: false,\n        'webPreferences': {\n            'nodeIntegration': true,\n            'webSecurity': true,\n            'allowDisplayingInsecureContent': false,\n            'allowRunningInsecureContent': false,\n            'java': false,\n            'webgl': false,\n            'webaudio': true,\n            'plugins': false,\n            'experimentalFeatures': false,\n            'experimentalCanvasFeatures': false,\n            'overlayScrollbars': true,\n            'textAreasAreResizable': false,\n            'directWrite': true\n        }\n    });\n\n    if (packageData.env.name === 'development') {\n        appMenu.setArdublocklyMenu(true);\n    } else {\n        appMenu.setArdublocklyMenu();\n    }\n\n    mainWindow.webContents.on('did-fail-load',\n        function(event, errorCode, errorDescription) {\n            winston.warn(tag + 'Page failed to load (' + errorCode + '). The ' +\n                'server is probably not yet running. Trying again in 200 ms.');\n            setTimeout(function() {\n                mainWindow.webContents.reload();\n            }, 350);\n        }\n    );\n\n    mainWindow.webContents.on('did-finish-load', function() {\n        if (splashWindow !== null) {\n            splashWindow.close();\n            splashWindow = null;\n        }\n        mainWindow.show();\n    });\n\n    mainWindow.on('close', function() {\n        mainWindow = null;\n    });\n\n    // Set the download directory to the home folder\n    mainWindow.webContents.session.setDownloadPath(\n        process.env[(process.platform == 'win32') ? 'USERPROFILE' : 'HOME']);\n\n    mainWindow.loadURL('http://localhost:8000/ardublockly');\n});\n\napp.on('window-all-closed', function() {\n    server.stopServer();\n    app.quit();\n});\n\nfunction createSplashWindow() {\n    if (splashWindow === null) {\n        var projectJetPath = projectLocator.getProjectRootJetpack();\n        var imagePath = 'file://' + projectJetPath.path(\n            'ardublockly', 'img', 'ardublockly_splash.png');\n\n        splashWindow = new BrowserWindow({\n            width: 450,\n            height: 300,\n            frame: false,\n            show: true,\n            transparent: true,\n            images: true,\n            center: true,\n            'alwaysOnTop': true,\n            'skipTaskbar': true,\n            'useContentSize': true\n        });\n        splashWindow.loadURL(imagePath);\n    }\n}\n\nfunction setupLogging() {\n    var projectRootPath = projectLocator.getProjectRootPath();\n    winston.add(winston.transports.File, {\n        json: false,\n        filename: projectRootPath + '/ardublockly.log',\n        maxsize: 10485760,\n        maxFiles: 2\n    });\n    winston.info(tag + 'Starting Ardublockly version: ' + packageData.version);\n    winston.info(tag + 'Ardublockly root dir: ' + projectRootPath);\n\n    // Relevant OS could be win32, linux, darwin\n    winston.info(tag + 'OS detected: ' + process.platform);\n}\n"],"names":[],"mappings":"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"}